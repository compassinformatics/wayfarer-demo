{"version":3,"file":"networkeditor-a2ee764e.js","sources":["../../src/js/networkeditor.js"],"sourcesContent":["import { buffer, boundingExtent } from 'ol/extent.js'\nimport { primaryAction } from 'ol/events/condition.js'\nimport { Draw } from 'ol/interaction.js'\nimport VectorLayer from 'ol/layer/Vector.js'\nimport VectorSource from 'ol/source/Vector.js'\nimport GeoJSON from 'ol/format/GeoJSON'\nimport { Stroke, Style } from 'ol/style.js'\n\nexport function clearNetworkEdits () {\n    networkEditsLayer.getSource().clear()\n}\n\nfunction resultsStyle (feature, resolution) {\n    return new Style({\n        stroke: new Stroke({\n            color: 'DeepPink',\n            width: 2\n        })\n    })\n};\n\nconst networkEditsLayer = new VectorLayer({\n    source: new VectorSource(),\n    style: resultsStyle\n})\n\nexport function getNetworkEdits () {\n    const geojsonFormat = new GeoJSON()\n    const feats = networkEditsLayer.getSource().getFeatures()\n    return geojsonFormat.writeFeatures(feats)\n}\n\nfunction isFeatureSnapped (map, coord, searchLayer) {\n    let extent = boundingExtent([coord]) // still a single point\n    const bufferDistance = map.getView().getResolution() * 1 // use a 6 pixel tolerance for snapping\n    extent = buffer(extent, bufferDistance) // buffer the point\n\n    const feats = searchLayer.getSource().getFeaturesInExtent(extent)\n\n    if (feats.length > 0) {\n        return true\n    } else {\n        return false\n    }\n}\n\nfunction drawEnd (evt, networkLayer) {\n    const feature = evt.feature\n\n    const geom = feature.getGeometry()\n    const networkSource = networkLayer.getSource()\n\n    const networkFeatureAtStart = networkSource.getClosestFeatureToCoordinate(geom.getFirstCoordinate())\n\n    // give the edited features negative ids so we can find them again later\n    // note the feature is only added to the layer once this method finishes so we add 1 to the length\n    const featureId = (networkEditsLayer.getSource().getFeatures().length + 1) * -1\n    feature.setId(featureId)\n\n    if (networkFeatureAtStart) {\n        feature.set('startFeatureId', networkFeatureAtStart.getId())\n    }\n\n    const networkFeatureAtEnd = networkSource.getClosestFeatureToCoordinate(geom.getLastCoordinate())\n\n    if (networkFeatureAtEnd) {\n        feature.set('endFeatureId', networkFeatureAtEnd.getId())\n    }\n}\n\nexport function createNetworkEditor (map, networkLayer) {\n    map.addLayer(networkEditsLayer)\n\n    const draw = new Draw({\n        source: networkEditsLayer.getSource(),\n        type: 'LineString',\n        condition: function (evt) {\n            if (primaryAction(evt) === true) {\n                return isFeatureSnapped(map, evt.coordinate, networkLayer)\n            } else {\n                return false\n            }\n        }\n    })\n\n    draw.on('drawend', function (evt) {\n        drawEnd(evt, networkLayer, networkEditsLayer)\n    })\n\n    return draw\n}\n"],"names":["clearNetworkEdits","networkEditsLayer","resultsStyle","feature","resolution","Style","Stroke","VectorLayer","VectorSource","getNetworkEdits","geojsonFormat","GeoJSON","feats","isFeatureSnapped","map","coord","searchLayer","extent","boundingExtent","bufferDistance","buffer","drawEnd","evt","networkLayer","geom","networkSource","networkFeatureAtStart","featureId","networkFeatureAtEnd","createNetworkEditor","draw","Draw","primaryAction"],"mappings":"uGAQO,SAASA,GAAqB,CACjCC,EAAkB,UAAW,EAAC,MAAO,CACzC,CAEA,SAASC,EAAcC,EAASC,EAAY,CACxC,OAAO,IAAIC,EAAM,CACb,OAAQ,IAAIC,EAAO,CACf,MAAO,WACP,MAAO,CACnB,CAAS,CACT,CAAK,CACL,CAEA,MAAML,EAAoB,IAAIM,EAAY,CACtC,OAAQ,IAAIC,EACZ,MAAON,CACX,CAAC,EAEM,SAASO,GAAmB,CAC/B,MAAMC,EAAgB,IAAIC,EACpBC,EAAQX,EAAkB,UAAS,EAAG,YAAa,EACzD,OAAOS,EAAc,cAAcE,CAAK,CAC5C,CAEA,SAASC,EAAkBC,EAAKC,EAAOC,EAAa,CAChD,IAAIC,EAASC,EAAe,CAACH,CAAK,CAAC,EACnC,MAAMI,EAAiBL,EAAI,QAAO,EAAG,cAAe,EAAG,EAKvD,OAJAG,EAASG,EAAOH,EAAQE,CAAc,EAExBH,EAAY,UAAS,EAAG,oBAAoBC,CAAM,EAEtD,OAAS,CAKvB,CAEA,SAASI,EAASC,EAAKC,EAAc,CACjC,MAAMpB,EAAUmB,EAAI,QAEdE,EAAOrB,EAAQ,YAAa,EAC5BsB,EAAgBF,EAAa,UAAW,EAExCG,EAAwBD,EAAc,8BAA8BD,EAAK,mBAAkB,CAAE,EAI7FG,GAAa1B,EAAkB,UAAS,EAAG,cAAc,OAAS,GAAK,GAC7EE,EAAQ,MAAMwB,CAAS,EAEnBD,GACAvB,EAAQ,IAAI,iBAAkBuB,EAAsB,MAAK,CAAE,EAG/D,MAAME,EAAsBH,EAAc,8BAA8BD,EAAK,kBAAiB,CAAE,EAE5FI,GACAzB,EAAQ,IAAI,eAAgByB,EAAoB,MAAK,CAAE,CAE/D,CAEO,SAASC,EAAqBf,EAAKS,EAAc,CACpDT,EAAI,SAASb,CAAiB,EAE9B,MAAM6B,EAAO,IAAIC,EAAK,CAClB,OAAQ9B,EAAkB,UAAW,EACrC,KAAM,aACN,UAAW,SAAUqB,EAAK,CACtB,OAAIU,EAAcV,CAAG,IAAM,GAChBT,EAAiBC,EAAKQ,EAAI,WAAYC,CAAY,EAElD,EAEd,CACT,CAAK,EAED,OAAAO,EAAK,GAAG,UAAW,SAAUR,EAAK,CAC9BD,EAAQC,EAAKC,CAA+B,CACpD,CAAK,EAEMO,CACX"}